<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <link rel="stylesheet" href="style.css">
  <title>WISH Charts</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    body { font-family: system-ui, Arial, sans-serif; max-width: 1100px; margin: 2rem auto; padding: 0 1rem; }
    .row { display: flex; gap: 1rem; align-items: center; flex-wrap: wrap; }
    .badge { display: inline-block; padding: .15rem .5rem; border-radius: .5rem; background: #eee; font-size: .8rem; }
    .latest { background: #d4f5d2; }
    details { margin: .75rem 0; }
    iframe { width: 100%; height: 700px; border: 1px solid #ddd; border-radius: .5rem; }
    .muted { color: #666; font-size: .9rem; }
    .error { color: #b00020; }
  </style>
</head>
<body>
  <h1>WISH Charts</h1>
  <div id="status" class="muted">Loading…</div>
  <div class="row">
    <label><input type="checkbox" id="latestOnly" checked> Show latest only</label>
  </div>
  <div id="viewer"></div>

<script>
(async function(){
  const params = new URLSearchParams(location.search);
  const id = (params.get("id") || "").replace(/\\D/g, "");
  const status = document.getElementById("status");
  const viewer = document.getElementById("viewer");
  const latestOnlyEl = document.getElementById("latestOnly");

  if (!id) { status.innerHTML = '<span class="error">Missing ?id=&lt;WISH&gt;</span>'; return; }

  let relations;
  try {
    relations = await fetch("relations.json").then(r=>r.json());
  } catch (e) {
    status.innerHTML = '<span class="error">Could not load relations.json</span>';
    return;
  }

  if (!(id in relations.wish_to_family)) {
    status.innerHTML = `<span class="error">WISH ${id} not found.</span>`; return;
  }

  const famIdx = relations.wish_to_family[id];
  const family = relations.families[famIdx];
  const members = family.members.slice();
  const latest = family.latest;

  function dateOf(w){ return relations.dates[w] || ""; }

  status.innerHTML = `Family for WISH <b>${id}</b> (${members.length} related). Latest is <b>${latest}</b>`;

  function pdfUrl(w){
    // All PDFs are served from repo at /pdf/<WISH>.pdf
    return `pdf/${w}.pdf`;
  }

  function render(){
    const show = latestOnlyEl.checked
      ? [latest]
      : members.sort((a,b) => (dateOf(a)||'').localeCompare(dateOf(b)||''));

    viewer.innerHTML = "";

    show.forEach(w => {
      const u = pdfUrl(w);
      const d = dateOf(w);
      const wrapper = document.createElement("div");
      wrapper.innerHTML = `
        <details open>
          <summary>
            <span class="badge ${w===latest ? "latest": ""}">${w===latest ? "LATEST" : "CHART"}</span>
            <b>WISH ${w}</b>
            <span class="muted"> ${d ? ` · ${d}`: ""}</span>
            · <a href="${u}" target="_blank" rel="noopener">Open PDF</a>
          </summary>
          <iframe src="${u}"></iframe>
        </details>
      `;
      viewer.appendChild(wrapper);
    });
  }

  latestOnlyEl.addEventListener("change", render);
  render();
})();
</script>
</body>
</html>
